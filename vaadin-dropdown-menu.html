<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../vaadin-control-state-mixin/vaadin-control-state-mixin.html">
<link rel="import" href="../vaadin-overlay/vaadin-overlay.html">
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<dom-module id="vaadin-dropdown-menu-overlay-styles" theme-for="vaadin-dropdown-menu-overlay">
  <template>
    <style>
      :host {
        align-items: flex-start;
        justify-content: flex-start;
      }

      [part~="overlay"] {
        min-width: 175px;
      }

      :host([phone]) {
        top: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        left: 0 !important;
        padding: 24px;
        align-items: stretch;
        justify-content: flex-end;
      }

      :host([phone]) [part="content"] {
        /* Ideally should be 100vh but iOS phone addr-bar covers view port */
        max-height: 80vh;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-dropdown-menu-text-field-default-theme" theme-for="vaadin-dropdown-menu-text-field">
  <template>
    <style>
      :host([has-value]) [part="value"] {
        visibility: hidden;
      }

      /* Override native styling for disabled-inputs so as placeholder looks ok */
      [part="value"]:disabled {
        opacity: 1;
      }

      [part="input-field"] {
        outline: none;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-dropdown-menu-overlay">
  <script>
    {
      /**
        * The overlay element.
        *
        * ### Styling
        *
        * See [`<vaadin-overlay>` documentation](https://github.com/vaadin/vaadin-overlay/blob/master/vaadin-overlay.html)
        * for `<vaadin-dropdown-menu-overlay>` parts.
        *
        * @memberof Vaadin
        * @extends Vaadin.OverlayElement
        */
      class VaadinDropdownMenuOverlayElement extends Vaadin.OverlayElement {
        static get is() {
          return 'vaadin-dropdown-menu-overlay';
        }
      }
      customElements.define(VaadinDropdownMenuOverlayElement.is, VaadinDropdownMenuOverlayElement);
    }
  </script>
</dom-module>

<dom-module id="vaadin-dropdown-menu-text-field">
  <script>
    {
      let memoizedTemplate;
      /**
        * The text-field element.
        *
        * ### Styling
        *
        * See [`<vaadin-text-field>` documentation](https://github.com/vaadin/vaadin-text-field/blob/master/vaadin-text-field.html)
        * for `<vaadin-dropdown-menu-text-field>` parts.
        *
        * @memberof Vaadin
        * @extends Vaadin.TextFieldElement
        */
      class VaadinDropdownMenuTextFieldElement extends Vaadin.TextFieldElement {
        static get is() {
          return 'vaadin-dropdown-menu-text-field';
        }

        static get template() {
          if (!memoizedTemplate) {
            // Clone the superclass template
            memoizedTemplate = super.template.cloneNode(true);

            // Create a slot for the value element
            const slot = document.createElement('slot');
            slot.setAttribute('name', 'selected');
            slot.setAttribute('part', 'selected');

            // Insert the slot before the text-field
            const input = memoizedTemplate.content.querySelector('input');

            input.parentElement.insertBefore(slot, input);
          }
          return memoizedTemplate;
        }

        get focusElement() {
          return this.root.querySelector('[part=input-field]');
        }
      }
      customElements.define(VaadinDropdownMenuTextFieldElement.is, VaadinDropdownMenuTextFieldElement);
    }
  </script>
</dom-module>

<dom-module id="vaadin-dropdown-menu">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      :host([hidden]) {
        display: none !important;
      }
    </style>

    <vaadin-dropdown-menu-text-field placeholder="[[placeholder]]" label="[[label]]" readonly value="[[_valueForInput]]">
      <slot name="prefix" slot="prefix"></slot>
      <div slot="selected"></div>
    </vaadin-dropdown-menu-text-field>
    <vaadin-dropdown-menu-overlay opened="{{opened}}" with-backdrop="[[_phone]]" phone$="[[_phone]]"></vaadin-dropdown-menu-overlay>

    <iron-media-query
      query="[[_phoneMediaQuery]]"
      query-matches="{{_phone}}">
    </iron-media-query>
  </template>

  <script>
    {
      /**
        * `<vaadin-dropdown-menu>` is a Polymer 2 element for selecting values from a list of items.
        *
        * ```
        * <vaadin-dropdown-menu>
        *   <template>
        *     <vaadin-list-box>
        *       <vaadin-item>Foo</vaadin-item>
        *       <vaadin-item>Bar</vaadin-item>
        *       <vaadin-item>Baz</vaadin-item>
        *     </vaadin-list-box>
        *   </template>
        * </vaadin-dropdown-menu>
        * ```
        *
        * @memberof Vaadin
        * @mixes Vaadin.ControlStateMixin
        * @mixes Vaadin.ThemableMixin
        * @demo demo/index.html
        */
      class DropdownMenuElement extends
        Vaadin.ControlStateMixin(
          Vaadin.ThemableMixin(
            Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element))) {
        static get is() {
          return 'vaadin-dropdown-menu';
        }

        static get properties() {
          return {
            /**
             * Set when the dropdown menu is open
             */
            opened: {
              type: Boolean,
              value: false,
              notify: true,
              observer: '_openedChanged'
            },

            /**
             * String used for the label element.
             */
            label: {
              type: String,
              value: ''
            },

            /**
             * It stores the string of the value property in the selected item.
             * It provides the value for iron-form.
             * When thereâ€™s an item selected, it's the value of that item, otherwise
             * it's an empty string.
             */
            value: {
              type: String,
              value: '',
              notify: true,
              observer: '_updateSelectedMenu'
            },

            /**
             * The current required state of the dropdown menu. True if required.
             */
            required: {
              type: Boolean,
              reflectToAttribute: true,
              observer: '_requiredChanged'
            },

            /**
             * The name of this element.
             */
            name: {
              type: String,
              reflectToAttribute: true
            },

            /**
             * A hint to the user of what can be entered in the control.
             */
            placeholder: {
              type: String
            },

            _phone: Boolean,

            _phoneMediaQuery: {
              value: '(max-width: 420px), (max-height: 420px)'
            },

            _overlayElement: Object,

            _inputElement: Object,

            _nativeInput: Object,

            // Used for setting a value to the input in order to show/hidde placeholder
            _valueForInput: Object
          };
        }

        /** @private */
        constructor() {
          super();
          this._boundSetPosition = this._setPosition.bind(this);
        }

        /** @private */
        connectedCallback() {
          super.connectedCallback();
          this.addEventListener('iron-resize', this._boundSetPosition);
        }

        ready() {
          super.ready();

          this._overlayElement = this.shadowRoot.querySelector('vaadin-dropdown-menu-overlay');
          this._selectionElement = this.shadowRoot.querySelector('[slot="selected"]');
          this._nativeInput = this.focusElement.shadowRoot.querySelector('input');
          this._nativeInput.setAttribute('aria-hidden', true);

          // Disabling the input fixes iOS zooming
          this._nativeInput.disabled = true;

          this.focusElement.addEventListener('click', e => this.opened = true);
          this.focusElement.addEventListener('keydown', e => this._onKeyDown(e));

          this._instance = this._createTemplateInstance();
          if (this._instance) {
            this._overlayElement.content = this._instance.root;
            this._menuElement = Array.from(this._overlayElement.$.content.children).filter(e => e._hasVaadinListMixin)[0];

            // If we have an initial value, we need to update the selected slot with the menu item content
            if (this.value && this._menuElement) {
              // To read item content we need menu DOM updated
              Polymer.RenderStatus.afterNextRender(this._menuElement, () => {
                this._menuElement._observer.flush(); // Ensure observer was run
                this._updateSelectedMenu();
              });
            }
          }
        }

        get focusElement() {
          return this._inputElement ||
            (this._inputElement = this.shadowRoot.querySelector('vaadin-dropdown-menu-text-field'));
        }

        /** @private */
        disconnectedCallback() {
          super.disconnectedCallback();
          this.removeEventListener('iron-resize', this._boundSetPosition);
          // Making sure the dropdown is closed and removed from DOM after detaching the dropdown.
          this.opened = false;
        }

        /** @private */
        notifyResize() {
          super.notifyResize();
          if (this.positionTarget && this.opened) {
            this._setPosition();
            // Schedule another position update (to cover virtual keyboard opening for example)
            requestAnimationFrame(this._setPosition.bind(this));
          }
        }

        _requiredChanged(required) {
          this.setAttribute('aria-required', required);
        }

        _onKeyDown(e) {
          if (!this.opened && /^(ArrowDown|Down|ArrowUp|Up|Enter|SpaceBar| )$/.test(e.key)) {
            e.preventDefault();
            this.opened = true;
          }
        }

        _onKeyDownInside(e) {
          if (/^(Tab)$/.test(e.key)) {
            this.opened = false;
          }
        }

        _openedChanged(opened, wasOpened) {
          if (!this._overlayElement || !this._menuElement || !this.focusElement || this.disabled) {
            this.opened = false;
            return;
          }

          if (opened) {
            this._menuElement.addEventListener('selected-changed', () => this._updateSelectedSlot());
            this._menuElement.addEventListener('keydown', e => this._onKeyDownInside(e));
            this._menuElement.addEventListener('click', e => this.opened = false);

            this._menuElement && Polymer.RenderStatus.afterNextRender(this._menuElement, () => this._menuElement.focus());
            this._setPosition();
            window.addEventListener('scroll', this._boundSetPosition, true);
          } else if (wasOpened) {
            !this._phone && this.focusElement.focus();
            this.validate();
            window.removeEventListener('scroll', this._boundSetPosition, true);
          }
        }

        _createTemplateInstance() {
          const template = this.querySelector('template');
          if (template) {
            const Templatizer = Polymer.Templatize.templatize(template, this, {
              instanceProps: {
                detail: true,
                target: true
              },
              forwardHostProp: function(prop, value) {
                this._instance && this._instance.forwardHostProp(prop, value);
              }
            });
            return new Templatizer({});
          }
        }

        _updateSelectedSlot() {
          this.opened = false;
          this._selectionElement.innerHTML = '';

          const selected = this._menuElement._navItems[this._menuElement.selected];
          if (selected) {
            if (selected.hasAttribute('label')) {
              this._selectionElement.textContent = selected.getAttribute('label');
              this._valueForInput = !!this._selectionElement.textContent;
            } else {
              const clone = selected.cloneNode(true);
              clone.removeAttribute('tabindex');
              this._selectionElement.appendChild(clone);
              this._valueForInput = selected.children.length || selected.textContent.trim() || '';
            }
          }

          if (!this._valueChanging) {
            this._selectedChanging = true;
            this.value = selected && selected.value || '';
            delete this._selectedChanging;
          }

          this.validate();
        }

        _updateSelectedMenu() {
          if (this._menuElement && this._menuElement._navItems) {
            this._menuElement.selected = this._menuElement._navItems.reduce((prev, item, idx) => {
              return item.value == this.value ? idx : prev;
            }, -1);
            if (!this._selectedChanging) {
              this._valueChanging = true;
              this._updateSelectedSlot();
              delete this._valueChanging;
            }
          }
        }

        _setPosition() {
          const inputRect = this.focusElement.getBoundingClientRect();

          this._overlayElement.style.left = inputRect.left + 'px';
          this._overlayElement.style.top = (inputRect.top <= window.innerHeight - inputRect.top ? inputRect.top :
            this._overlayElement.style.top = inputRect.bottom - this._overlayElement.$.overlay.offsetHeight) + 'px';
        }

        /** @protected */
        validate() {
          if (this.disabled || !this.required || this.value) {
            this.removeAttribute('invalid');
            return true;
          }
          this.setAttribute('invalid', '');
        }
      }

      customElements.define(DropdownMenuElement.is, DropdownMenuElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin = window.Vaadin || {};
      Vaadin.DropdownMenuElement = DropdownMenuElement;
    }
  </script>
</dom-module>
